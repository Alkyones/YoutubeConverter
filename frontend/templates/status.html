{% extends 'base.html' %}
{% load static %}

{% block head %}
<title>YConv - Download Status</title>
<style>
    .status-hero {
        background: var(--bg-hero);
        padding: 6rem 0 3rem 0;
        margin-top: -20px;
        position: relative;
        overflow: hidden;
    }
    .status-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 30% 70%, rgba(255, 107, 0, 0.15) 0%, transparent 50%);
        z-index: 1;
    }
    .status-hero-content {
        position: relative;
        z-index: 2;
    }
    .status-icon {
        width: 120px;
        height: 120px;
        background: rgba(255, 107, 0, 0.15);
        backdrop-filter: blur(20px);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        border: 2px solid rgba(255, 107, 0, 0.3);
    }
    .status-title {
        color: white;
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .status-subtitle {
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.25rem;
        margin-bottom: 0;
    }
    .modern-table-container {
        background: var(--bg-card);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 2rem;
        margin: 2rem;
        box-shadow: var(--shadow-xl);
        border: 1px solid var(--border-color);
        max-width: 100%;
    }
    .modern-table {
        border: none;
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        width: 100%;
        margin-bottom: 0;
        table-layout: auto;
    }
    .table-responsive {
        border-radius: 16px;
        overflow: hidden;
    }
    @media (max-width: 992px) {
        .table-responsive {
            overflow-x: auto;
        }
    }
    .modern-table thead th {
        background: var(--primary-gradient);
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 1rem 0.75rem;
        border: none;
        white-space: nowrap;
    }
    .modern-table tbody tr {
        transition: all 0.3s ease;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-card);
    }
    .modern-table tbody tr:hover {
        background: var(--bg-tertiary);
    }
    .modern-table tbody td {
        padding: 1rem 0.75rem;
        border: none;
        vertical-align: middle;
        font-size: 0.875rem;
        color: var(--text-primary) !important;
    }
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border: none;
        white-space: nowrap;
        display: inline-block;
    }
    .badge-completed {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }
    .badge-progress {
        background: var(--primary-gradient);
        color: white;
    }
    .badge-queued {
        background: linear-gradient(135deg, #555 0%, #777 100%);
        color: white;
    }
    .badge-error {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
    }
    .format-badge {
        background: rgba(255, 107, 0, 0.15);
        color: var(--primary);
        padding: 0.25rem 0.75rem;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.75rem;
    }
    .quality-badge {
        background: rgba(255, 107, 0, 0.1);
        color: var(--primary);
        padding: 0.25rem 0.75rem;
        border-radius: 25px;
        font-weight: 500;
        font-size: 0.75rem;
        border: 1px solid rgba(255, 107, 0, 0.3);
    }
    .url-link {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        max-width: 350px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
    }
    .url-link:hover {
        color: var(--primary-light);
        text-decoration: underline;
    }
    .action-btn {
        background: var(--primary-gradient);
        border: none;
        border-radius: 12px;
        padding: 0.75rem 2rem;
        color: white;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        color: white;
    }
    .action-btn-secondary {
        background: transparent;
        border: 2px solid var(--primary);
        border-radius: 12px;
        padding: 0.75rem 2rem;
        color: var(--primary);
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }
    .action-btn-secondary:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    .btn-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }
    .empty-icon {
        font-size: 4rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
    }
    .title-cell {
        color: var(--text-primary) !important;
        font-weight: 500;
    }
    .table {
        --bs-table-color: var(--text-primary);
        --bs-table-bg: transparent;
        color: var(--text-primary);
    }
    .text-muted {
        color: var(--text-muted) !important;
    }
    .error-text {
        color: #ff6b6b;
        font-size: 0.8rem;
    }
    @media (max-width: 768px) {
        .modern-table-container {
            margin: 1rem;
            padding: 1rem;
        }
        .status-title {
            font-size: 2rem;
        }
        .modern-table {
            font-size: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="status-hero">
    <div class="container-fluid">
        <div class="status-hero-content">
            <div class="text-center">
                <div class="status-icon">
                    <i class="fas fa-chart-line" style="font-size: 3rem; color: white;"></i>
                </div>
                <h1 class="status-title">Download Status</h1>
                <p class="status-subtitle">Track your YouTube downloads in real-time</p>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-4">
    <div class="modern-table-container">
        <div class="table-responsive">
            <table class="table modern-table">
                <thead>
                    <tr>
                        <th>TITLE</th>
                        <th>LINK</th>
                        <th>FORMAT</th>
                        <th>QUALITY</th>
                        <th>STATUS</th>
                        <th>ERROR MESSAGE</th>
                        <th>CREATED</th>
                        <th>UPDATED</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>
                            <div class="title-cell text-truncate" style="max-width: 350px;">
                                {{ task.title|default:"N/A" }}
                            </div>
                        </td>
                        <td>
                            <a href="{{ task.link }}" target="_blank" class="url-link" title="{{ task.link }}">
                                {{ task.link|truncatechars:60 }}
                            </a>
                        </td>
                        <td>
                            <span class="format-badge">{{ task.format|upper }}</span>
                        </td>
                        <td>
                            <span class="quality-badge">{{ task.quality|capfirst }}</span>
                        </td>
                        <td>
                            {% if task.status == "Completed" %}
                                <span class="status-badge badge-completed">
                                    <i class="fas fa-check-circle me-1"></i>{{ task.status }}
                                </span>
                            {% elif task.status == "In Progress" %}
                                <span class="status-badge badge-progress">
                                    <i class="fas fa-spinner fa-spin me-1"></i>{{ task.status }}
                                </span>
                            {% elif task.status == "Queued" %}
                                <span class="status-badge badge-queued">
                                    <i class="fas fa-clock me-1"></i>{{ task.status }}
                                </span>
                            {% else %}
                                <span class="status-badge badge-error">
                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ task.status }}
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="text-truncate error-text" style="max-width: 300px;" title="{{ task.error_message }}">
                                {{ task.error_message|default:"-" }}
                            </div>
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ task.created_at|date:"M d, H:i" }}
                            </small>
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ task.updated_at|date:"M d, H:i" }}
                            </small>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-inbox"></i>
                                </div>
                                <h4>No Downloads Yet</h4>
                                <p>Start downloading some YouTube videos to see them here!</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="text-center mb-5">
        <div class="btn-group">
            <a href="{% url 'index' %}" class="action-btn">
                <i class="fas fa-arrow-left"></i>
                Back to Converter
            </a>
            <button onclick="openDownloadsFolder()" class="action-btn-secondary">
                <i class="fas fa-folder-open"></i>
                Open Downloads
            </button>
        </div>
    </div>
</div>

<script>
    function openDownloadsFolder() {
        fetch("{% url 'open_downloads_folder' %}")
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Could not open folder: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Could not open downloads folder');
            });
    }
    // Auto-refresh status every 5 seconds
    function fetchTaskStatus() {
        fetch("{% url 'get_task_status' %}")
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector(".modern-table tbody");
                
                if (data.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8">
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fas fa-inbox"></i>
                                    </div>
                                    <h4>No Downloads Yet</h4>
                                    <p>Start downloading some YouTube videos to see them here!</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = "";
                
                data.forEach(task => {
                    const statusBadge = getStatusBadge(task.status);
                    const row = `
                        <tr>
                            <td>
                                <div class="title-cell text-truncate" style="max-width: 350px;">
                                    ${task.title || 'N/A'}
                                </div>
                            </td>
                            <td>
                                <a href="${task.link}" target="_blank" class="url-link" title="${task.link}">
                                    ${task.link.length > 60 ? task.link.substring(0, 60) + '...' : task.link}
                                </a>
                            </td>
                            <td>
                                <span class="format-badge">${task.format ? task.format.toUpperCase() : 'N/A'}</span>
                            </td>
                            <td>
                                <span class="quality-badge">${task.quality ? task.quality.charAt(0).toUpperCase() + task.quality.slice(1) : 'N/A'}</span>
                            </td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="text-truncate error-text" style="max-width: 300px;" title="${task.error_message || ''}">
                                    ${task.error_message || '-'}
                                </div>
                            </td>
                            <td>
                                <small class="text-muted">
                                    ${formatDate(task.created_at)}
                                </small>
                            </td>
                            <td>
                                <small class="text-muted">
                                    ${formatDate(task.updated_at)}
                                </small>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            })
            .catch(error => console.log('Error fetching status:', error));
    }
    
    function getStatusBadge(status) {
        const badges = {
            'Completed': '<span class="status-badge badge-completed"><i class="fas fa-check-circle me-1"></i>Completed</span>',
            'In Progress': '<span class="status-badge badge-progress"><i class="fas fa-spinner fa-spin me-1"></i>In Progress</span>',
            'Queued': '<span class="status-badge badge-queued"><i class="fas fa-clock me-1"></i>Queued</span>'
        };
        return badges[status] || '<span class="status-badge badge-error"><i class="fas fa-exclamation-triangle me-1"></i>' + status + '</span>';
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit'
        });
    }
    
    // Refresh status every 5 seconds
    setInterval(fetchTaskStatus, 5000);
</script>
{% endblock %}